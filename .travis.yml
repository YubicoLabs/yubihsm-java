language: java

matrix:
  include:
    - name: 'openjdk8'
      os: linux
      dist: trusty
      jdk: openjdk8
    - name: 'oracle8'
      os: linux
      dist: trusty
      jdk: oraclejdk8
    - name: 'oracle9'
      os: linux
      dist: trusty
      jdk: oraclejdk9
    - name: 'openjdk10'
      os: linux
      dist: xenial
      jdk: openjdk10
    - name: 'openjdk11'
      os: linux
      dist: xenial
      jdk: openjdk11
    - name: 'oracle11'
      os: linux
      dist: trusty
      jdk: oraclejdk11

env:
  global:
    - secure: "STomB43EWa5RP8KuX6I7998fyvvzrnt1cb/mp+hb9e5s1Fs6TZ8/WC1XDBNn+GAmDmXay7hDjiQGRTMCjzKI0h1Cma+u94iH1JoYMJDAuQswtRs+0DjwPe4daoaTGHTnzYhtkfiFDEM69omDp9rRlfVPrLOC0iFVXCo8h/aMMFrprEJhiH8Xc9S/LnT3BxX1tEXMcFx9UEHBmTCDtS0TLWfQuX+fbJ+t9+CQY+oM/EBvJnemUgGEciJPcQklZ8jhcNOD1fGyRweEdKp7Bk5KlROTEzDdxiX9BgftTRtSfQ2YuJeS0+ZPVqhm0BCeX7wTzt+QU+4QdyDXXy7fGdEaYBreWdlqe/fn3gi+tCB1B0Q8dMcR5qpKkRN0DfQAJuEoGBBJf3Nhfn3evZGICxm6Iss5d/9/kZSR60gaULrzqvLmThjlJ6N4wqqzJkEKSvFICJSExRXgBh7GzS57sf6H3eYtNBpadqg/34WQWvUDBlc9QeKIZ/np3AXd/52PkXT4QXzL9fP98UnqPJYmJaPlh2w1n2M72reTXyrcG6mGw9H3GNxIue27Ei7Wcnv75TjDJCLKUcrzEPOiizNQDYGHqdfRGp8wJyt2ExlotRDxFDR+JH6M5Y/2Wl1RnCNGabsYo3TyHoHSp4SCkwX1Z3kff5U+oC0RfW2eR+prk2YpcUE="

before_install:
  - openssl aes-256-cbc -k "$tlspwd" -md sha256 -in ./.ci/client-combined.pem.enc -out ./.ci/client-combined.pem -d


script:
  - export krnl="$(uname -s | tr '[:upper:]' '[:lower:]')"
  - wget https://github.com/square/ghostunnel/releases/download/v1.3.1/ghostunnel-v1.3.1-$krnl-amd64-with-pkcs11 -O ghostunnel
  - chmod +x ./ghostunnel
  - ./ghostunnel client --listen localhost:12345 --target hsm-connector01.sthlm.in.yubico.org:8443 --keystore ./.ci/client-combined.pem --cacert ./.ci/server-crt.pem 2>/dev/null &
  - sleep 3
  - export DEFAULT_CONNECTOR_URL="$(curl http://localhost:12345/dispatcher/request)"
  - echo DEFAULT_CONNECTOR_URL=$DEFAULT_CONNECTOR_URL
  - ./gradlew clean test
  - ./gradlew clean optionsTest
  - travis_wait 30 ./gradlew clean integrationTest

after_failure:
  - less build/reports/tests/integrationTest/classes/*

after_script:
  - curl "http://localhost:12345/dispatcher/release?connector=$DEFAULT_CONNECTOR_URL"
