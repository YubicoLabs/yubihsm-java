language: java

matrix:
  include:
    - name: 'openjdk8'
      os: linux
      dist: trusty
      jdk: openjdk8
    - name: 'oracle8'
      os: linux
      dist: trusty
      jdk: oraclejdk8
    - name: 'oracle9'
      os: linux
      dist: trusty
      jdk: oraclejdk9
    - name: 'openjdk10'
      os: linux
      dist: xenial
      jdk: openjdk10
    - name: 'openjdk11'
      os: linux
      dist: xenial
      jdk: openjdk11
    - name: 'oracle11'
      os: linux
      dist: trusty
      jdk: oraclejdk11

env:
  global:
    - secure: "XZh0UL7YLG5LF9N9cahIK8ao8UuhmxkXOLaO3nrPz6muOX9wT2RbXQAU7cFuXa/OmYezB+4bfhn90/tZkFIww8lUe1jjQClRmdrR/uoZt29G9VY1gY4UtvqtA+Rk66HtBNHARqz5wvRV9bXpkQBgfsCyndqcssS/JQFXQ1s2o5T5id2ijO66KTtDyU8OcjR0MQnp7KytwHLPo1yVs+bl2x17qm2JTXvBxb8XjQrxpvq6lHY69oMWTTf7xtTtLqt4D6Ne24vdoD5cnhYkY2uZPreIZqjmBTeZM27sWsHA/nDixB+Sp6kdkJaRwFgy3LSe9oIcdeLd0IxP7sKsXBHNgTSrVT/xNz5Ycq+hfqqFC5BqAQ3/wLkvagGL557+OXJBgAeHwd6OUh6T8N85SLsBoHdIm2T8Z/P7iRwrioaCfqDcDbaNa9B4Th8tUxRqcsjWM7pcyeXQxkbpb0dnIZ8pPO9st9DR2AfWKXrrXDjfJT0Ma7KZdSyP03OMs3/9SQU5YkMrErNHjQqJlKsb60S/01lOyB65D9BYd5PH7mYUd5B7mDL2yw0qbrgTJNz0j70nA15oEzNXOgXzMj46VI61oCmai2U3ayq9zVnyVXV7cTC0ZNbW/Nnkji7gbi1LuqMhDOEx6z2wrj37Jvc1KB2c5+CO6W9lo1RJQ3gn5/A9J3g="

before_install:
  - openssl aes-256-cbc -k "$tlspwd" -md sha256 -in ./.ci/client-combined.pem.enc -out ./.ci/client-combined.pem -d -pbkdf2


script:
  - export krnl="$(uname -s | tr '[:upper:]' '[:lower:]')"
  - wget https://github.com/square/ghostunnel/releases/download/v1.3.1/ghostunnel-v1.3.1-$krnl-amd64-with-pkcs11 -O ghostunnel
  - chmod +x ./ghostunnel
  - ./ghostunnel client --listen localhost:12345 --target hsm-connector01.sthlm.in.yubico.org:8443 --keystore ./.ci/client-combined.pem --cacert ./.ci/server-crt.pem 2>/dev/null &
  - sleep 3
  - export DEFAULT_CONNECTOR_URL="$(curl http://localhost:12345/dispatcher/request)"
  - echo DEFAULT_CONNECTOR_URL=$DEFAULT_CONNECTOR_URL
  - ./gradlew clean test
  - ./gradlew clean optionsTest
  - travis_wait 30 ./gradlew clean integrationTest

after_failure:
  - less build/reports/tests/integrationTest/classes/*

after_script:
  - curl "http://localhost:12345/dispatcher/release?connector=$DEFAULT_CONNECTOR_URL"
